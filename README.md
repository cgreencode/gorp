## Goals ##

* Forward engineer db schema from structs (especially good for unit tests)
* Optional optimistic locking using a version column
* Pre/post insert/update/delete hooks
* Automatically generate insert/update statements for a struct
* Delete by primary key
* Select by primary key

## Non-Goals ##

* Eliminate need to know SQL
* Graph loads


## Example ##

First define some types:

    type DbStruct {
        Id        int64,
        Created   int64,
        Updated   int64,
        Version   int32,
    }
    
    type Product struct {
        DbStruct
        Description  string,
        UnitPrice    int32,   // in pennies
        IsTaxable    bool
    }
    
    type Order struct {
        DbStruct
        PaymentType  string,
        IsPaid       bool,
        SalesTax     int32
    }
    
    type LineItem struct {
        DbStruct
        OrderId      int64,
        ProductId    int64,
        Quantity     int32,
        UnitPrice    int32
    }

Then create a mapper, typically you'd do this one time at app startup

    // connect to db
    db, err := sql.Open("mysql", "myuser:mypassword@localhost:3306/dbname")
    
    // construct a mapper
    mapper := gorp.NewMapper(db)

Then save some data

    p1 := &Product{Description: "Wool socks", UnitPrice: 499, IsTaxable: true}
    p2 := &Product{Description: "Tofu", UnitPrice: 249, IsTaxable: false}
    mapper.Save(p1, p2)

    // more complex example with automated error handling
    func SaveOrder(order *Order, items []LineItem) err error {
        // will commit or rollback transaction
        // if an error occurred at any point, a rollback
        // is performed, and the error returned here
        defer err = mapper.End()

        mapper.Begin()   
        o1 := &Order{PaymentType: "cash"}
        mapper.Save(o1)
    
        l1 := &LineItem{Quantity: 2, ProductId: p1.Id, OrderId: o1.Id}
        l2 := &LineItem{Quantity: 1, ProductId: p2.Id, OrderId: o1.Id}
        mapper.Save(l1, l2)

    }
    
How would I set the date updated/created?

    // implement the PreInsert and PreUpdate hooks
    func (d *DbStruct) PreInsert(mapper *gorp.Mapper) error {
        d.Created = time.Nanoseconds()
        d.Updated = d.Created
        return nil
    }
    
    func (d *DbStruct) PreUpdate(mapper *gorp.Mapper) error {
        d.Updated = time.Nanoseconds()
        return nil
    }
    
How do you hook autogenerated primary keys?

    // implement the PostInsert hook
    func (d *DbStruct) PostInsert(mapper *gorp.Mapper) error {
        res, err := mapper.RawQuery("select last_insert_id()")
        if res != nil {
            res.Next()
            res.Scan(&d.Id)
            res.Close()
        }
    }

What is Version used for?

    // Version is an auto-incremented number, managed by gorp
    // If this property is present on your struct, update
    // operations will be constrained
    //
    // For example:
    
    p1 := &Product{Description: "Wool socks", UnitPrice: 499, IsTaxable: true}
    mapper.Save(p1)  // Version is now 1
    
    p2 := mapper.Get(Product, p1.Id)
    p2.UnitPrice = 599
    mapper.Save(p2)  // Version is now 2
    
    p1.UnitPrice = 399
    err := mapper.Save(p1)  // Raises error - p1.Version == 1, which is stale
    if err != nil {
        // should reach this statement
        fmt.Printf("Got err: %v\n", err)
    }
    
